<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MongoDB - Consultas Entre Cole√ß√µes</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%); color:white; overflow:hidden; }
        .container { width:100vw; height:100vh; display:flex; align-items:stretch; justify-content:stretch; position:relative; }
        .slide { display:none; width:100%; height:100vh; padding:40px 60px; background:rgba(255,255,255,0.05); backdrop-filter:blur(20px); overflow-y:auto; animation:slideIn .5s ease-out; }
        .slide.active { display:block; }
        @keyframes slideIn { from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
        h1 { font-size:3rem; text-align:center; margin-bottom:18px; background:linear-gradient(45deg,#fff,#a8d8ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        h2 { font-size:2.2rem; margin-bottom:12px; color:#4ecdc4; display:flex; align-items:center; gap:12px; }
        h3 { font-size:1.6rem; margin:18px 0 12px; color:#ffd93d; }
        h4 { font-size:1.25rem; margin:12px 0 10px; color:#a8d8ff; }
        .emoji { font-size:2rem; }
        .code-container { background:rgba(0,0,0,0.4); border-radius:10px; padding:18px; margin:16px 0; border-left:4px solid #4ecdc4; }
        .code-title { color:#4ecdc4; font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
        pre { margin:0 !important; font-size:.92rem; line-height:1.4; }
        .concept-box { background:rgba(255,255,255,0.1); border-radius:12px; padding:18px; margin:16px 0; border-left:5px solid #ffd93d; }
        .result-box { background:rgba(76,175,80,0.2); border-radius:10px; padding:16px; margin:12px 0; border-left:4px solid #4caf50; }
        .explanation-box { background:rgba(255,193,7,0.2); border-radius:10px; padding:16px; margin:12px 0; border-left:4px solid #ffc107; }
        .warning { background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.5); border-radius:8px; padding:14px; margin:12px 0; color:#ffb3b3; }
        .success { background:rgba(76,175,80,0.2); border:1px solid rgba(76,175,80,0.5); border-radius:8px; padding:14px; margin:12px 0; color:#c8e6c9; }
        .highlight { background:linear-gradient(120deg, rgba(255,217,61,.3) 0%, rgba(255,217,61,.1) 100%); padding:2px 6px; border-radius:4px; color:#ffd93d; font-weight:700; }
        ul { margin:14px 0; padding-left:20px; }
        li { margin:8px 0; line-height:1.55; }
        .two-column { display:grid; grid-template-columns:1fr 1fr; gap:26px; margin:16px 0; }
        .navigation { position:fixed; bottom:22px; left:50%; transform:translateX(-50%); display:flex; gap:12px; z-index:1000; }
        .nav-btn { background:rgba(255,255,255,0.2); color:white; border:none; padding:10px 20px; border-radius:22px; cursor:pointer; font-size:1rem; transition:.25s; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.2); }
        .nav-btn:hover { background:rgba(255,255,255,0.3); transform:translateY(-2px); }
        .nav-btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }
        .slide-counter { position:fixed; top:20px; right:20px; background:rgba(255,255,255,0.2); padding:8px 16px; border-radius:18px; backdrop-filter:blur(10px); }
        @media (max-width:768px){ .two-column{ grid-template-columns:1fr; } h1{ font-size:2rem; } h2{ font-size:1.7rem; } .slide{ padding:20px 26px; } }
        .step-indicator { background:rgba(78,205,196,0.3); color:#4ecdc4; padding:4px 10px; border-radius:14px; font-size:.85rem; font-weight:700; margin-right:8px; }
        .performance-tip { background:rgba(255,193,7,0.15); border-left:4px solid #ffc107; padding:12px; margin:12px 0; border-radius:6px; }
        .kbd { padding:.15rem .35rem; border:1px solid rgba(255,255,255,.3); border-bottom-width:2px; border-radius:4px; font-family:monospace; }
        .objective { background:rgba(78,205,196,0.18); border-left:4px solid #4ecdc4; padding:10px 12px; border-radius:8px; margin:10px 0 6px; color:#cfeff0; }
    </style>
</head>
<body>
<div class="container">

<!-- Slide 1 -->
<div class="slide active">
  <h1>Consultas Entre Cole√ß√µes MongoDB</h1>
  <div class="objective">Objetivo: contextualizar o sistema escolar, cole√ß√µes e ferramentas usadas, alinhando premissas de schema.</div>
  <div style="text-align:center; margin:18px 0 28px;">
    <div style="font-size:3.6rem; margin:18px 0;">üîó</div>
    <h2>Dominando $lookup, agrega√ß√µes e relacionamentos</h2>
    <div style="font-size:1.05rem; color:#a8d8ff; line-height:1.6;">
      <p>Sistema Escolar ‚Ä¢ Cole√ß√µes: alunos, cursos, turmas, professores, contadores</p>
      <p>Ferramentas: mongosh + Aggregation Framework</p>
    </div>
  </div>
  <div class="concept-box">
    <h3>üì¶ Modelo de dados (premissas)</h3>
    <ul>
      <li>alunos: { _id, nome, email, ativo, bolsista, curso_id, turma_id, endereco: { cidade } }</li>
      <li>cursos: { _id, nome, departamento, coordenador_professor_id }</li>
      <li>turmas: { _id, codigo, semestre, curso_id }</li>
      <li>professores: { _id, nome, departamento }</li>
      <li>contadores: { _id, valor, descricao }</li>
    </ul>
  </div>
  <div class="warning"><b>Pr√©-requisito:</b> use sistema_escolar ‚Ä¢ Garanta √≠ndices nos campos de jun√ß√£o (curso_id, etc.).</div>
</div>

<!-- Slide 2 -->
<div class="slide">
  <h2>üìö Passo a passo de um $lookup b√°sico</h2>
  <div class="objective">Objetivo: mostrar o fluxo m√≠nimo de um join (lookup ‚Üí project ‚Üí sort) e como contar/filtrar itens do array.</div>
  <div class="explanation-box">
    <p><span class="step-indicator">PASSO 1</span>$lookup junta documentos de duas cole√ß√µes por igualdade de campos.</p>
    <p><span class="step-indicator">PASSO 2</span>$project seleciona e calcula campos finais.</p>
    <p><span class="step-indicator">PASSO 3</span>$sort ordena o resultado.</p>
  </div>
  <div class="code-container">
    <div class="code-title">Cursos com seus alunos</div>
    <pre><code class="language-javascript">db.cursos.aggregate([
  { $lookup: {
      from: "alunos",
      localField: "_id",
      foreignField: "curso_id",
      as: "alunos_matriculados"
  }},
  { $project: {
      nome: 1,
      departamento: 1,
      total_alunos: { $size: "$alunos_matriculados" },
      alunos_ativos: {
        $size: {
          $filter: {
            input: "$alunos_matriculados",
            as: "a",
            cond: { $eq: ["$$a.ativo", true] }
          }
        }
      },
      bolsistas: {
        $size: {
          $filter: {
            input: "$alunos_matriculados",
            as: "a",
            cond: { $eq: ["$$a.bolsista", true] }
          }
        }
      }
  }},
  { $sort: { total_alunos: -1 } }
])</code></pre>
  </div>
  <div class="performance-tip">Crie √≠ndice em alunos.curso_id: <code>db.alunos.createIndex({curso_id:1})</code></div>
</div>

<!-- Slide 3 -->
<div class="slide">
  <h2>üë• Consulta reversa: alunos ‚Üí curso</h2>
  <div class="objective">Objetivo: trazer o objeto do curso por aluno usando $lookup e $unwind, com proje√ß√£o dos campos √∫teis.</div>
  <div class="code-container">
    <div class="code-title">$lookup + $unwind + $project</div>
    <pre><code class="language-javascript">db.alunos.aggregate([
  { $lookup: {
      from: "cursos",
      localField: "curso_id",
      foreignField: "_id",
      as: "curso"
  }},
  { $unwind: "$curso" }, // transforma [obj] em obj
  { $project: {
      nome: 1, email: 1, ativo: 1,
      "curso.nome": 1, "curso.departamento": 1
  }},
  { $match: { ativo: true } },
  { $limit: 10 }
])</code></pre>
  </div>
  <div class="warning">Se quiser manter alunos sem curso, use: <code>{ $unwind: { path:"$curso", preserveNullAndEmptyArrays:true } }</code></div>
</div>

<!-- Slide 4 -->
<div class="slide">
  <h2>üèÜ Ranking por departamento</h2>
  <div class="objective">Objetivo: agregar ap√≥s o join, consolidando m√©tricas por chave com $group.</div>
  <div class="code-container">
    <div class="code-title">$group agregando arrays j√° juntados</div>
    <pre><code class="language-javascript">db.cursos.aggregate([
  { $lookup: {
      from: "alunos",
      localField: "_id",
      foreignField: "curso_id",
      as: "alunos"
  }},
  { $group: {
      _id: "$departamento",
      total_cursos: { $sum: 1 },
      total_alunos: { $sum: { $size: "$alunos" } },
      alunos_ativos: { $sum: {
        $size: {
          $filter: { input: "$alunos", as: "a", cond: { $eq: ["$$a.ativo", true] } }
        }
      } }
  }},
  { $sort: { total_alunos: -1 } }
])</code></pre>
  </div>
  <div class="explanation-box">No $group, o documento ‚Äúcurso‚Äù √© reduzido a m√©tricas por _id = departamento.</div>
</div>

<!-- Slide 5 -->
<div class="slide">
  <h2>üî¢ Contadores (sequ√™ncias at√¥micas)</h2>
  <div class="objective">Objetivo: gerar sequ√™ncias num√©ricas at√¥micas com $inc, evitando colis√µes.</div>
  <div class="two-column">
    <div>
      <div class="code-container">
        <div class="code-title">Ver contadores</div>
        <pre><code class="language-javascript">db.contadores.find().pretty()</code></pre>
      </div>
      <div class="code-container">
        <div class="code-title">Incrementar matr√≠cula</div>
        <pre><code class="language-javascript">db.contadores.findOneAndUpdate(
  { _id: "matriculas" },
  { $inc: { valor: 1 } },
  { returnDocument: "after" }
)</code></pre>
      </div>
    </div>
    <div>
      <div class="explanation-box">
        <h4>Por que $inc?</h4>
        <ul>
          <li>Opera√ß√£o at√¥mica ‚Üí sem duplicidade.</li>
          <li>Mais r√°pido que varrer cole√ß√£o para achar MAX.</li>
        </ul>
      </div>
      <div class="performance-tip">Crie √≠ndice em <code>_id</code> (j√° existe por padr√£o).</div>
    </div>
  </div>
</div>

<!-- Slide 6 -->
<div class="slide">
  <h2>üë®‚Äçüè´ Professores ‚Üî alunos via departamento</h2>
  <div class="objective">Objetivo: usar $lookup com pipeline e vari√°veis (let/$$) para filtrar a cole√ß√£o ‚Äúfrom‚Äù.</div>
  <div class="code-container">
    <div class="code-title">$lookup com pipeline e vari√°veis</div>
    <pre><code class="language-javascript">db.professores.aggregate([
  { $lookup: {
      from: "cursos",
      localField: "departamento",
      foreignField: "departamento",
      as: "cursos_departamento"
  }},
  { $lookup: {
      from: "alunos",
      let: { cursos_ids: "$cursos_departamento._id" },
      pipeline: [
        { $match: { $expr: { $in: ["$curso_id", "$$cursos_ids"] } } }
      ],
      as: "alunos_departamento"
  }},
  { $project: {
      nome: 1, departamento: 1,
      total_cursos: { $size: "$cursos_departamento" },
      total_alunos: { $size: "$alunos_departamento" },
      alunos_ativos: { $size: {
        $filter: { input:"$alunos_departamento", as:"a", cond:{ $eq:["$$a.ativo", true] } }
      } }
  }},
  { $sort: { total_alunos: -1 } }
])</code></pre>
  </div>
  <div class="explanation-box">Note o uso de <span class="highlight">let</span> e <span class="highlight">$$</span> para passar vari√°veis entre est√°gios do lookup.</div>
</div>

<!-- Slide 7 -->
<div class="slide">
  <h2>üéì Turmas + cursos + alunos</h2>
  <div class="objective">Objetivo: combinar m√∫ltiplos joins e projetar m√©tricas em uma vis√£o por turma.</div>
  <div class="code-container">
    <div class="code-title">M√∫ltiplos lookups + unwind</div>
    <pre><code class="language-javascript">db.turmas.aggregate([
  { $lookup: { from:"cursos", localField:"curso_id", foreignField:"_id", as:"curso" } },
  { $lookup: { from:"alunos", localField:"curso_id", foreignField:"curso_id", as:"alunos_curso" } },
  { $unwind: "$curso" },
  { $project: {
      codigo:1, semestre:1,
      "curso.nome":1, "curso.departamento":1,
      total_alunos_curso: { $size:"$alunos_curso" },
      alunos_ativos: { $size: { $filter:{ input:"$alunos_curso", as:"a", cond:{ $eq:["$$a.ativo", true] } } } }
  }},
  { $sort: { semestre: -1, total_alunos_curso: -1 } }
])</code></pre>
  </div>
  <div class="performance-tip">√çndice sugerido: <code>db.turmas.createIndex({curso_id:1, semestre:-1})</code></div>
</div>

<!-- Slide 8 -->
<div class="slide">
  <h2>üìä Relat√≥rio 360¬∞ por departamento</h2>
  <div class="objective">Objetivo: consolidar professores, cursos e alunos em KPIs por departamento.</div>
  <div class="code-container">
    <div class="code-title">$group + m√∫ltiplos $lookup encadeados</div>
    <pre><code class="language-javascript">db.professores.aggregate([
  { $group: {
      _id: "$departamento",
      professores: { $push: "$nome" },
      total_professores: { $sum: 1 }
  }},
  { $lookup: {
      from: "cursos",
      localField: "_id",
      foreignField: "departamento",
      as: "cursos"
  }},
  { $lookup: {
      from: "alunos",
      let: { cursos_ids: "$cursos._id" },
      pipeline: [{ $match: { $expr: { $in: ["$curso_id", "$$cursos_ids"] } } }],
      as: "alunos"
  }},
  { $project: {
      departamento: "$_id", _id: 0,
      total_professores:1,
      cursos_top3: { $slice: ["$cursos.nome", 3] },
      total_cursos: { $size: "$cursos" },
      total_alunos: { $size: "$alunos" },
      ativos: { $size: { $filter:{ input:"$alunos", as:"a", cond:{ $eq:["$$a.ativo", true] } } } },
      bolsistas: { $size: { $filter:{ input:"$alunos", as:"a", cond:{ $eq:["$$a.bolsista", true] } } } }
  }},
  { $sort: { total_alunos: -1 } }
])</code></pre>
  </div>
</div>

<!-- Slide 9 -->
<div class="slide">
  <h2>üåç Alunos por cidade e departamento</h2>
  <div class="objective">Objetivo: cruzar localiza√ß√£o do aluno com o departamento do curso usando chave composta no $group.</div>
  <div class="code-container">
    <div class="code-title">Join + group por campos compostos</div>
    <pre><code class="language-javascript">db.alunos.aggregate([
  { $lookup: { from: "cursos", localField: "curso_id", foreignField: "_id", as: "curso" } },
  { $unwind: "$curso" },
  { $group: {
      _id: { cidade: "$endereco.cidade", departamento: "$curso.departamento" },
      total_alunos: { $sum: 1 },
      alunos_ativos: { $sum: { $cond: [{ $eq: ["$ativo", true] }, 1, 0] } },
      bolsistas: { $sum: { $cond: [{ $eq: ["$bolsista", true] }, 1, 0] } }
  }},
  { $project: {
      _id: 0, cidade: "$_id.cidade", departamento: "$_id.departamento",
      total_alunos:1, alunos_ativos:1, bolsistas:1
  }},
  { $sort: { total_alunos: -1 } },
  { $limit: 15 }
])</code></pre>
  </div>
</div>

<!-- Slide 10 -->
<div class="slide">
  <h2>‚ö° Performance: √≠ndices e explain</h2>
  <div class="objective">Objetivo: garantir IXSCAN com √≠ndices corretos e evitar erros de tipagem em curso_id vs _id.</div>

  <div class="explanation-box">
    <h4>Regra de ouro</h4>
    <ul>
      <li>O tipo de <code>alunos.curso_id</code> deve ser o MESMO de <code>cursos._id</code>.</li>
      <li>Antes de consultar, DETECTE o tipo para evitar erros ou matches vazios.</li>
    </ul>
  </div>

  <div class="code-container">
    <div class="code-title">1) Descobrir o tipo de curso_id e _id</div>
    <pre><code class="language-javascript">db.alunos.aggregate([{ $limit: 1 }, { $project: { _id:0, tipo: { $type: "$curso_id" }, curso_id: 1 } }])
db.cursos.findOne({}, { _id: 1, nome: 1 })</code></pre>
  </div>

  <div class="code-container">
    <div class="code-title">2) Montando a consulta conforme o tipo</div>
    <pre><code class="language-javascript">/* A) ObjectId */
const cursoObj = db.cursos.findOne({}, { _id: 1 })
db.alunos.find({ curso_id: cursoObj._id, ativo: true }).explain("executionStats")
/* B) String */
const cs = db.cursos.findOne({}, { _id: 1 })
db.alunos.find({ curso_id: cs._id, ativo: true }).explain("executionStats")
/* C) N√∫mero */
const cn = db.cursos.findOne({}, { _id: 1 })
db.alunos.find({ curso_id: cn._id, ativo: true }).explain("executionStats")</code></pre>
  </div>

  <div class="warning">
    <b>Erros comuns</b>
    <ul>
      <li>Usar <code>ObjectId("...")</code> inv√°lido (BSONError).</li>
      <li>Tipos diferentes entre <code>curso_id</code> e <code>_id</code>.</li>
      <li>Assumir que <code>_id</code> √© sempre ObjectId.</li>
    </ul>
  </div>

  <div class="two-column">
    <div>
      <div class="code-container">
        <div class="code-title">√çndice composto recomendado</div>
        <pre><code class="language-javascript">db.alunos.createIndex({ curso_id: 1, ativo: 1 })</code></pre>
      </div>
      <div class="code-container">
        <div class="code-title">Outros √≠ndices √∫teis</div>
        <pre><code class="language-javascript">db.alunos.createIndex({ turma_id:1 })
db.turmas.createIndex({ curso_id:1 })
db.cursos.createIndex({ departamento:1 })
db.professores.createIndex({ departamento:1 })</code></pre>
      </div>
    </div>
    <div>
      <div class="result-box">
        <h4>üìä Explain saud√°vel</h4>
        <pre><code class="language-json">{
  "stage": "IXSCAN",
  "indexName": "curso_id_1_ativo_1",
  "totalKeysExamined": 4,
  "totalDocsExamined": 4,
  "nReturned": 4
}</code></pre>
      </div>
      <div class="performance-tip">
        Procure por IXSCAN. Se aparecer COLLSCAN em consultas cr√≠ticas,
        crie/ajuste √≠ndices.
      </div>
    </div>
  </div>

  <div class="explanation-box">
    <h4>Padroniza√ß√£o (opcional, recomendado)</h4>
    <ul>
      <li>Padronize <code>curso_id</code> para o mesmo tipo do <code>_id</code> em <code>cursos</code> (geralmente ObjectId).</li>
      <li>Depois, ative valida√ß√£o com <code>$jsonSchema</code>.</li>
    </ul>
  </div>
</div>

<!-- Slide 11 -->
<div class="slide">
  <h2>üß∞ Guia r√°pido de est√°gios</h2>
  <div class="objective">Objetivo: revisar os principais est√°gios e quando us√°-los no fluxo.</div>
  <div class="two-column">
    <div class="concept-box">
      <h4>Est√°gios principais</h4>
      <ul>
        <li><b>$match</b>: filtra documentos no come√ßo do pipeline.</li>
        <li><b>$lookup</b>: junta cole√ß√µes; use √≠ndices no localField/foreignField.</li>
        <li><b>$unwind</b>: explode arrays em m√∫ltiplas linhas.</li>
        <li><b>$group</b>: agrega por chave _id.</li>
        <li><b>$project</b>: escolhe e calcula campos.</li>
        <li><b>$sort</b>, <b>$limit</b>, <b>$skip</b>: ordena e pagina.</li>
      </ul>
    </div>
    <div class="concept-box">
      <h4>Operadores √∫teis</h4>
      <ul>
        <li><b>$filter</b>(input, as, cond): filtra elementos de um array.</li>
        <li><b>$size</b>(array): tamanho do array.</li>
        <li><b>$map</b>, <b>$reduce</b>: transformar/colapsar arrays.</li>
        <li><b>$cond</b>: if/else em express√µes.</li>
        <li><b>$eq</b>, <b>$in</b>, <b>$gte</b> (compara√ß√£o); <b>$sum</b>, <b>$avg</b> (agregadores).</li>
        <li><b>let / $$var</b>: passar vari√°veis no $lookup (pipeline).</li>
      </ul>
    </div>
  </div>

  <div class="explanation-box">
    <h4>Est√°gios vs Operadores</h4>
    <ul>
      <li><b>Est√°gios</b> s√£o as etapas do pipeline (ex.: <code>{$match: ...}</code>, <code>{$project: ...}</code>).</li>
      <li><b>Operadores</b> s√£o fun√ß√µes usadas dentro dos est√°gios (ex.: <code>$eq</code>, <code>$in</code>, <code>$filter</code>, <code>$cond</code>, <code>$sum</code>).</li>
      <li>Ex.: <code>{$project: { status: { $cond: [ { $gte: ["$nota", 7] }, "OK", "ATEN√á√ÉO" ] } }}</code></li>
    </ul>
  </div>
</div>

<!-- Slide 12 -->
<div class="slide">
  <h2>üîé $lookup com pipeline (filtro no lado ‚Äújoin‚Äù)</h2>
  <div class="objective">Objetivo: filtrar a cole√ß√£o ‚Äúfrom‚Äù dentro do pr√≥prio $lookup para reduzir dados e ganhar performance.</div>
  <div class="code-container">
    <div class="code-title">Cursos com apenas alunos ativos (join j√° filtrado)</div>
    <pre><code class="language-javascript">db.cursos.aggregate([
  { $lookup: {
      from: "alunos",
      let: { idCurso: "$_id" },
      pipeline: [
        { $match: { $expr: { $eq: ["$curso_id", "$$idCurso"] } } },
        { $match: { ativo: true } }
      ],
      as: "alunos_ativos"
  }},
  { $project: { nome:1, departamento:1, ativos: { $size: "$alunos_ativos" } } },
  { $sort: { ativos: -1 } }
])</code></pre>
  </div>
  <div class="explanation-box">Quando o filtro envolve campos da cole√ß√£o ‚Äúfrom‚Äù, use pipeline dentro do $lookup.</div>
</div>

<!-- Slide 13 -->
<div class="slide">
  <h2>üßÆ KPIs por curso com $facet</h2>
  <div class="objective">Objetivo: gerar m√∫ltiplas vis√µes em paralelo a partir do mesmo fluxo.</div>
  <div class="code-container">
    <div class="code-title">V√°rias vis√µes paralelas</div>
    <pre><code class="language-javascript">db.cursos.aggregate([
  { $lookup: { from:"alunos", localField:"_id", foreignField:"curso_id", as:"alunos" } },
  { $facet: {
      kpi: [
        { $project: {
            nome:1,
            total: { $size:"$alunos" },
            ativos: { $size: { $filter:{ input:"$alunos", as:"a", cond:{ $eq:["$$a.ativo", true] } } } },
            bolsistas: { $size: { $filter:{ input:"$alunos", as:"a", cond:{ $eq:["$$a.bolsista", true] } } } }
        } },
        { $sort: { total:-1 } }
      ],
      topCursos: [
        { $project: { nome:1, total: { $size:"$alunos" } } },
        { $sort: { total:-1 } }, { $limit: 5 }
      ]
  } }
])</code></pre>
  </div>
  <div class="explanation-box">$facet retorna um √∫nico documento com m√∫ltiplos arrays de resultado (kpi, topCursos).</div>
</div>

<!-- Slide 14 -->
<div class="slide">
  <h2>üß™ Erros comuns e corre√ß√µes</h2>
  <div class="objective">Objetivo: evitar armadilhas frequentes e acelerar a depura√ß√£o.</div>
  <div class="warning">
    <ul>
      <li>Usar <b>$this/$$this</b> dentro de $filter ‚Üí Corrija para <b>as:"a"</b> e <b>$$a</b>.</li>
      <li>Campos inexistentes em $project ‚Üí Remova ou proteja com <code>{$ifNull:[ "$campo", valor ]}</code>.</li>
      <li>Texto solto ap√≥s <span class="kbd">])</span> no mongosh ‚Üí Gera ‚ÄúMissing semicolon‚Äù.</li>
      <li>Falta de √≠ndice no lado ‚Äúforeign‚Äù do $lookup ‚Üí COLLSCAN lento.</li>
    </ul>
  </div>
  <div class="success">
    <b>Dica:</b> Desenvolva por partes. Teste cada $match, depois o $lookup, s√≥ ent√£o $group/$project.
  </div>
</div>

<!-- Slide 15 -->
<div class="slide">
  <h2>üßπ Proje√ß√µes limpas e tipagem</h2>
  <div class="objective">Objetivo: limpar/formatar sa√≠da e proteger caminhos nulos com $ifNull.</div>
  <div class="code-container">
    <div class="code-title">Selecionando campos essenciais</div>
    <pre><code class="language-javascript">db.alunos.aggregate([
  { $match: { ativo: true } },
  { $project: {
      _id:0, nome:1, email:1,
      curso_id:1,
      cidade: { $ifNull: ["$endereco.cidade", "N/D"] }
  } },
  { $limit: 20 }
])</code></pre>
  </div>
  <div class="explanation-box">$ifNull evita erros quando o caminho n√£o existe.</div>
</div>

<!-- Slide 16 -->
<div class="slide">
  <h2>üîê Valida√ß√£o por schema (collMod)</h2>
  <div class="objective">Objetivo: aplicar regras ($jsonSchema) para padronizar tipos obrigat√≥rios e bloquear dados inv√°lidos.</div>
  <div class="code-container">
    <div class="code-title">Obrigando curso_id/turma_id como ObjectId</div>
    <pre><code class="language-javascript">db.runCommand({
  collMod: "alunos",
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["nome", "curso_id", "turma_id"],
      properties: {
        nome: { bsonType: "string" },
        curso_id: { bsonType: "objectId" },
        turma_id: { bsonType: "objectId" },
        ativo: { bsonType: "bool" },
        bolsista: { bsonType: "bool" }
      }
    }
  },
  validationLevel: "moderate"
})</code></pre>
  </div>
</div>

<!-- Slide 17 -->
<div class="slide">
  <h2>üß≠ Pagina√ß√£o eficiente</h2>
  <div class="objective">Objetivo: usar range paging por _id para escalar melhor do que skip.</div>
  <div class="code-container">
    <div class="code-title">Usando <i>range paging</i> com _id</div>
    <pre><code class="language-javascript">// P√°gina 1
const page1 = db.alunos.find().sort({ _id: 1 }).limit(20).toArray();
const lastId = page1.length ? page1[page1.length - 1]._id : null;

// Pr√≥xima p√°gina (guarde e reutilize o _id real, sem converter de novo)
const page2 = lastId
  ? db.alunos.find({ _id: { $gt: lastId } }).sort({ _id: 1 }).limit(20).toArray()
  : [];</code></pre>
  </div>
  <div class="performance-tip">Evite <code>skip</code> em cole√ß√µes grandes; <i>range paging</i> escala melhor.</div>
</div>

<!-- Slide 18 -->
<div class="slide">
  <h2>üß∑ Denormaliza√ß√£o consciente</h2>
  <div class="objective">Objetivo: saber quando repetir campos para leituras r√°pidas e como manter consist√™ncia.</div>
  <div class="concept-box">
    <ul>
      <li>Repita campos lidos com alta frequ√™ncia (ex.: curso_nome no aluno).</li>
      <li>Mantenha triggers/scripts para sincronizar quando o ‚Äúdono‚Äù mudar.</li>
    </ul>
  </div>
  <div class="code-container">
    <div class="code-title">Exemplo</div>
    <pre><code class="language-javascript">db.alunos.updateMany(
  { curso_id: ObjectId("...") },
  { $set: { curso_nome: "Licenciatura em Matem√°tica" } }
)</code></pre>
  </div>
</div>

<!-- Slide 19 -->
<div class="slide">
  <h2>üìù Exerc√≠cios pr√°ticos</h2>
  <div class="objective">Objetivo: fixar joins, agrega√ß√µes e KPIs com desafios graduais.</div>
  <div class="two-column">
    <div class="code-container">
      <div class="code-title">B√°sico</div>
      <pre><code class="language-javascript">// 1) Cursos de Engenharia com alunos ativos.
// 2) Departamento com mais professores.
// 3) Top-5 turmas por n√∫mero de alunos.
// 4) Cidades √∫nicas com count.</code></pre>
    </div>
    <div class="code-container">
      <div class="code-title">Intermedi√°rio / Avan√ßado</div>
      <pre><code class="language-javascript">// 5) Ranking por reten√ß√£o (ativos/total).
// 6) Bolsistas em cursos de Medicina.
// 7) Professores com alunos de m√∫ltiplas cidades.
// 8) ROI por departamento: (alunos_ativos / professores * cursos).</code></pre>
    </div>
  </div>
</div>

<!-- Slide 20 -->
<div class="slide">
  <h2>üéì Resumo e pr√≥ximos passos</h2>
  <div class="objective">Objetivo: consolidar aprendizados e apontar caminhos avan√ßados.</div>
  <div class="two-column">
    <div class="concept-box">
      <h4>Voc√™ aprendeu</h4>
      <ul>
        <li>$lookup b√°sico e com pipeline</li>
        <li>$unwind, $group, $project, $filter, $size</li>
        <li>$facet e KPIs paralelos</li>
        <li>√çndices, explain, valida√ß√£o e pagina√ß√£o</li>
      </ul>
    </div>
    <div class="concept-box">
      <h4>Continue com</h4>
      <ul>
        <li>$graphLookup para hierarquias</li>
        <li>Transa√ß√µes (replica set)</li>
        <li>Change Streams em tempo real</li>
        <li>MongoDB Atlas Search</li>
      </ul>
    </div>
  </div>
  <div style="text-align:center; margin-top:18px; font-size:1.1rem;">
    <p style="color:#4ecdc4;">üöÄ Pratique no mongosh em blocos pequenos e me pe√ßa ajustes conforme seu schema real.</p>
  </div>
</div>

</div>

<!-- Navega√ß√£o -->
<div class="navigation">
  <button class="nav-btn" id="prevBtn" onclick="changeSlide(-1)">‚Üê Anterior</button>
  <button class="nav-btn" id="nextBtn" onclick="changeSlide(1)">Pr√≥ximo ‚Üí</button>
</div>

<!-- Contador -->
<div class="slide-counter"><span id="slideCounter">1 / 20</span></div>

<script>
  let currentSlide = 0;
  const slides = document.querySelectorAll('.slide');
  const totalSlides = slides.length;

  function showSlide(n){
    slides.forEach(s=>s.classList.remove('active'));
    if(n>=totalSlides) currentSlide = totalSlides-1;
    if(n<0) currentSlide = 0;
    slides[currentSlide].classList.add('active');
    document.getElementById('slideCounter').textContent = (currentSlide+1)+" / "+totalSlides;
    document.getElementById('prevBtn').disabled = currentSlide===0;
    document.getElementById('nextBtn').disabled = currentSlide===totalSlides-1;
  }
  function changeSlide(d){ currentSlide += d; showSlide(currentSlide); }
  document.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft') changeSlide(-1);
    if(e.key==='ArrowRight') changeSlide(1);
    if(e.key==='Home'){ currentSlide=0; showSlide(currentSlide); }
    if(e.key==='End'){ currentSlide=totalSlides-1; showSlide(currentSlide); }
  });
  showSlide(0);
</script>
</body>
</html>